<!DOCTYPE html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Information Visualization - Project 4 - Subway History</title>

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="http://netdna.bootstrapcdn.com/bootstrap/3.1.0/css/bootstrap.min.css">

    <script src="http://d3js.org/d3.v3.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>

    <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jquerymobile/1.4.3/jquery.mobile.min.css" />
    <script src="https://ajax.googleapis.com/ajax/libs/jquerymobile/1.4.3/jquery.mobile.min.js"></script>
    
</head>
<body align="middle" style="padding: 2% 5%">
    <div id="visual"></div>
    <div id="slider" data-role="fieldcontain" style="padding: 2% 5%">
        <input type="range" name="slider-1" id="slider-1" value="1933" min="1933" max="2015" data-highlight="true"/>
    </div>
    <style>
        line {
            fill: none;
            stroke-width: 7px;
        }

        circle {
            stroke: gray;
            stroke-width: 2px;
            fill: white;
        }
    </style>
    <script>
        var year_shown = 1933;
        var year_entered = 1933;

        $("#slider").change(function() {
            year_entered = $("#slider-1").val();
            changeStations();
        });

        /* The array contains longitude and latitude instead of simple x and y.
        This is done in order for the window size to be dynamic and a conversion can
        be done to get the correct x and y.*/
        var stations = [
            {'id':"T-Centralen", 'x':580, 'y':400, 'year':1933, 'before':"", 'line-color':""},
            {'id':"Karlaplan", 'x':300, 'y':360, 'year':1937, 'before':"T-Centralen", 'line-color':"red"},
            {'id':"Östermalmstorg", 'x':480, 'y':200, 'year':2000, 'before':"Östermalmstorg", 'line-color':"red"}
        ];

        var svg = d3.select("#visual").append("svg")
            .attr("width", 960)
            .attr("height", 500);

        
        var line = svg.selectAll("line")
            .data([stations]);

        var subway = svg.selectAll("circle")
            .data([stations]);


        var initialStation = subway
          .enter().append("circle")
            .attr("r", 8)
            .attr("id", function(d){return d[0]['id']})
            .attr("cx", function(d){return d[0]['x']})
            .attr("cy", function(d){return d[0]['y']});

        function changeStations() {
            // This part adds stations that should be visible after the slider has been changed
            if(year_shown != year_entered && year_shown < year_entered) {
                for(var i = 0; i < stations.length; i++) {
                    if(stations[i]["year"] > year_shown && stations[i]["year"] <= year_entered) {
                        addStation(i);
                        year_shown = year_entered;
                    }
                }
            }
            // This part removes stations that should be visible after the slider has been changed
            else if(year_shown != year_entered && year_shown > year_entered) {
                for(var i = 0; i < stations.length; i++) {
                    if(stations[i]["year"] <= year_shown && stations[i]["year"] > year_entered) {
                        removeStation(i);
                        year_shown = year_entered;
                    }
                }
            }
        }

        function addStation(index) {
            var stationBefore = findStation(stations[index]["before"]);
            var addedLine = line.enter().append("line")
                .attr("id", stations[index]["id"] + "-line")
                .attr("x1", stations[index]["x"])
                .attr("y1", stations[index]["y"])
                .attr("x2", stations[stationBefore]["x"])
                .attr("y2", stations[stationBefore]["y"])
                .attr("stroke", stations[index]["line-color"]);

            var addedStation = subway.enter().append("circle") 
                .attr("r", 8)
                .attr("id", stations[index]["id"] + "-circle")
                .attr("cx", stations[index]["x"])
                .attr("cy", stations[index]["y"]);
        }

        function removeStation(index) {
            var id = "#" + stations[index]["id"] + "-line";
            var removedLine = d3.select(id).remove();

            id = "#" + stations[index]["id"] + "-circle";
            var removedStation = d3.select(id).remove();
        }

        function findStation(id) {
            for(var i = 0; i < stations.length; i++) {
                if(id == stations[i]["id"]) {
                    return i;
                }
            }
        }
    </script>
</body>